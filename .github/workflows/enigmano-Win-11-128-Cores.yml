name: Jor3a-Ti9niya-RDP-Cloudflare-Auto

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: üì• Download Cloudflared
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Downloading Cloudflared..."
          try {
              Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"
              Write-Host "[SUCCESS] Cloudflared downloaded."
          } catch {
              Write-Host "[FAILED] Cloudflared download failed: $_"
              exit 1
          }

      - name: ‚öôÔ∏è Enable Remote Desktop
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Enabling Remote Desktop..."
          try {
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
              Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
              Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
              Write-Host "[SUCCESS] Remote Desktop enabled."
          } catch {
              Write-Host "[FAILED] Failed to enable Remote Desktop: $_"
              exit 1
          }

      - name: üë§ Create Local User
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Creating local user 'runneradmin'..."
          try {
              $securePass = ConvertTo-SecureString "admin@123" -AsPlainText -Force
              if (-not (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue)) {
                  New-LocalUser -Name "runneradmin" -Password $securePass -FullName "Runner Admin" -Description "User for RDP"
                  Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
              }
              Write-Host "[SUCCESS] Local user 'runneradmin' exists."
          } catch {
              Write-Host "[FAILED] Failed to create user: $_"
              exit 1
          }

      - name: üåê Start Cloudflare Tunnel (Auto)
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Starting Cloudflare Tunnel for RDP..."
          try {
              Start-Process -FilePath "$env:USERPROFILE\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389 --no-autoupdate" -NoNewWindow -WindowStyle Hidden
              Write-Host "[SUCCESS] Cloudflare Tunnel started. Check logs to see public endpoint."
          } catch {
              Write-Host "[FAILED] Failed to start Cloudflare Tunnel: $_"
              exit 1
          }

      - name: ‚è± Keep Runner Alive (6h)
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Keeping runner active for 6 hours..."
          $endTime = (Get-Date).AddHours(6)
          try {
              while ((Get-Date) -lt $endTime) {
                  $remaining = $endTime - (Get-Date)
                  Write-Host "‚è≥ Time remaining: $($remaining.Hours)h $($remaining.Minutes)m $($remaining.Seconds)s"
                  Start-Sleep -Seconds 60
              }
              Write-Host "[SUCCESS] 6-hour runner maintenance completed."
          } catch {
              Write-Host "[FAILED] Keep-alive encountered an error: $_"
              exit 1
          }

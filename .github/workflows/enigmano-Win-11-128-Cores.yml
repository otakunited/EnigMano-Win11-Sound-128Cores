name: "‚ö° EnigMano Win11 via Chrome Remote Desktop"

on:
  workflow_dispatch:
    inputs:
      CRD_CODE:
        description: "Chrome Remote Desktop Auth Code"
        required: true
        default: "4/xxxxxxx"

jobs:
  deploy-crd:
    name: "üöÄ Deploy Win11 + CRD"
    runs-on: windows-2022

    steps:
      - name: ‚öôÔ∏è Setup Environment
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          function Log($msg) { Write-Host "[CRD $(Get-Date -Format 'HH:mm:ss')] $msg" }

          Log "üîπ Initialisation de l‚Äôenvironnement"

          try {
            Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
            Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
            Log "‚úÖ RDP local activ√©"
          } catch { Log "‚ö†Ô∏è Impossible d‚Äôactiver RDP local : $_" }

      - name: üñ•Ô∏è Installer Chrome Remote Desktop
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          function Log($msg) { Write-Host "[CRD $(Get-Date -Format 'HH:mm:ss')] $msg" }
          
          Log "‚è≥ T√©l√©chargement CRD..."
          Invoke-WebRequest "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" -OutFile "crd.msi"

          Log "‚è≥ Installation CRD..."
          Start-Process msiexec.exe -ArgumentList "/i crd.msi /qn" -Wait
          Log "‚úÖ Chrome Remote Desktop install√©"

      - name: üöÄ Lancer Chrome Remote Desktop Host
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          function Log($msg) { Write-Host "[CRD $(Get-Date -Format 'HH:mm:ss')] $msg" }
          function Fail($msg) { Write-Error "[CRD-ERROR $(Get-Date -Format 'HH:mm:ss')] $msg"; Exit 1 }

          $crdExe = "${env:ProgramFiles(x86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          if (-Not (Test-Path $crdExe)) {
            Fail "‚ùå Fichier CRD introuvable : $crdExe"
          }

          $authCode = "${{ github.event.inputs.CRD_CODE }}"
          if ([string]::IsNullOrWhiteSpace($authCode)) {
            Fail "‚ùå Aucun code CRD fourni"
          }

          Log "‚è≥ Lancement CRD avec code $authCode"
          Start-Process -FilePath $crdExe `
            -ArgumentList "--code=`"$authCode`" --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=$env:COMPUTERNAME" `
            -NoNewWindow -PassThru
          
          Log "‚úÖ Chrome Remote Desktop Host d√©marr√©"
          Log "‚û°Ô∏è Connecte-toi sur https://remotedesktop.google.com/access"

      - name: üïí Keep Alive
        shell: pwsh
        run: |
          for ($i=0; $i -lt 48; $i++) {
            Write-Host "[CRD $(Get-Date -Format 'HH:mm:ss')] üíì Instance active ($i/48)"
            Start-Sleep -Seconds 900
          }

name: Jor3a-Ti9niya-RDP-CRD

on:
  workflow_dispatch:

jobs:
  setup-chrome-rdp:
    runs-on: windows-latest

    steps:
    - name: üì• Check out the repository
      uses: actions/checkout@v2

    - name: üñ•Ô∏è Enable RDP & Firewall
      shell: pwsh
      run: |
        Write-Host "[DEBUG] Enabling RDP..."
        try {
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          Write-Host "[SUCCESS] RDP enabled and firewall configured."
        } catch {
          Write-Host "[FAILED] RDP enable failed: $_"
          exit 1
        }

        Write-Host "[DEBUG] Creating local user 'runneradmin'..."
        try {
          Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "admin@123" -Force)
          Write-Host "[SUCCESS] Local user 'runneradmin' created/updated."
        } catch {
          Write-Host "[FAILED] Creating local user failed: $_"
          exit 1
        }

    - name: üåê Install Chrome Remote Desktop Host
      shell: pwsh
      run: |
        $CRDPath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        if (-Not (Test-Path $CRDPath)) {
          Write-Host "[DEBUG] Chrome Remote Desktop not found, downloading..."
          Invoke-WebRequest "https://dl.google.com/chrome-remote-desktop/chrome-remote-desktop.msi" -OutFile "$env:TEMP\crd.msi"
          Start-Process msiexec.exe -ArgumentList "/i $env:TEMP\crd.msi /qn" -Wait
          Write-Host "[SUCCESS] Chrome Remote Desktop installed."
        } else {
          Write-Host "[DEBUG] Chrome Remote Desktop already installed."
        }

    - name: üöÄ Start Chrome Remote Desktop Host
      shell: pwsh
      run: |
        $CRDPath = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        $Code = "4/0AVMBsJiIdkqeHq3dOOlekXZuom4C6FbDDzrvbE8qk--aUn3pnjmafaBwdk11M8XEWXUNlQ"
        $RedirectURL = "https://remotedesktop.google.com/_/oauthredirect"
        $ComputerName = $Env:COMPUTERNAME
        $PIN = "123456"

        Write-Host "[DEBUG] Starting Chrome Remote Desktop host..."
        try {
          $Arguments = "--code=`"$Code`" --redirect-url=`"$RedirectURL`" --name=`"$ComputerName`" --pin=`"$PIN`""
          Write-Host "[DEBUG] Running command: $CRDPath $Arguments"
          Start-Process -FilePath $CRDPath -ArgumentList $Arguments -NoNewWindow
          Write-Host "[SUCCESS] Chrome Remote Desktop started successfully."
        } catch {
          Write-Host "[FAILED] Failed to start Chrome Remote Desktop: $_"
          exit 1
        }

        Write-Host "[DEBUG] Monitoring CRD process for 60 seconds..."
        for ($i = 0; $i -lt 60; $i++) {
          Start-Sleep -Seconds 1
          $proc = Get-Process | Where-Object { $_.Path -eq $CRDPath }
          if ($proc) {
            Write-Host "[DEBUG] Process running, PID: $($proc.Id)"
          } else {
            Write-Host "[DEBUG] Waiting for process to start..."
          }
        }
        Write-Host "[SUCCESS] Chrome Remote Desktop host setup completed. Connect via https://remotedesktop.google.com/access using PIN: $PIN"

    - name: üïí Keep Runner Alive
      shell: pwsh
      run: |
        Write-Host "[DEBUG] Keeping runner alive for 6 hours..."
        Start-Sleep -Seconds 21600
        Write-Host "[SUCCESS] Runner alive period completed."

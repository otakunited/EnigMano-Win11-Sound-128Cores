name: RDP + noVNC + Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  setup-rdp-novnc:
    runs-on: windows-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v2

      - name: üîß Enable RDP
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 1
          $secPass = ConvertTo-SecureString "admin@123" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $secPass
          Write-Host "[SUCCESS] RDP enabled"

      - name: üíª Install TightVNC Server
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Downloading TightVNC..."
          $vncUrl = "https://www.tightvnc.com/download/2.8.63/tightvnc-2.8.63-gpl-setup-64bit.msi"
          $vncInstaller = "$env:TEMP\tightvnc.msi"
          Invoke-WebRequest -Uri $vncUrl -OutFile $vncInstaller
          Write-Host "[DEBUG] Installing TightVNC silently..."
          Start-Process msiexec.exe -ArgumentList "/i `"$vncInstaller`" /qn" -Wait
          Write-Host "[SUCCESS] TightVNC installed"

      - name: üñ• Start VNC Server
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Starting TightVNC Server..."
          Start-Process "C:\Program Files\TightVNC\tvnserver.exe" -ArgumentList "-start" -NoNewWindow
          Start-Sleep -Seconds 5
          Write-Host "[SUCCESS] TightVNC server started"

      - name: üï∏ Install noVNC
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Downloading noVNC..."
          $noVNCUrl = "https://github.com/novnc/noVNC/archive/refs/heads/master.zip"
          $zipPath = "$env:TEMP\novnc.zip"
          Invoke-WebRequest -Uri $noVNCUrl -OutFile $zipPath
          Expand-Archive $zipPath -DestinationPath "$env:TEMP\novnc"
          Write-Host "[SUCCESS] noVNC ready"

      - name: üöÄ Start noVNC (Websockify)
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Starting noVNC websockify on port 6080..."
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install websockify
          Start-Process python -ArgumentList "-m websockify 6080 localhost:5900" -NoNewWindow
          Start-Sleep -Seconds 5
          Write-Host "[SUCCESS] noVNC started"

      - name: üåê Start Cloudflare Tunnel
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Downloading cloudflared..."
          Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:TEMP\cloudflared.exe"
          Write-Host "[DEBUG] Starting Cloudflare Tunnel to noVNC..."
          Start-Process "$env:TEMP\cloudflared.exe" -ArgumentList "tunnel --url http://localhost:6080 --no-autoupdate" -NoNewWindow
          Write-Host "[DEBUG] Waiting 10s for tunnel to establish..."
          Start-Sleep -Seconds 10
          Write-Host "[SUCCESS] Cloudflare Tunnel started. Connect via browser when public URL is available."

      - name: ‚è± Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "[DEBUG] Keeping GitHub Runner alive..."
          Start-Sleep -Seconds 21600

name: Deploy EnigMano Win11 + CRD

# Trigger manually or on push
on:
  workflow_dispatch:

jobs:
  deploy-windows:
    runs-on: windows-latest
    env:
      CRD_PIN: 123456  # <-- choose your secure 6-digit PIN here

    steps:
      # Step 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install dependencies (PowerShell modules, etc.)
      - name: Setup PowerShell environment
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          Install-Module -Name PSReadLine -Force -SkipPublisherCheck
          # Add any other setup commands your build needs

      # Step 3: Download or setup EnigMano Win11 build
      - name: Setup EnigMano Win11
        run: |
          Write-Host "Downloading EnigMano Win11 + CRD..."
          # Example: adjust your URL/path
          Invoke-WebRequest -Uri "https://github.com/otakunited/EnigMano-Win11-Sound-128Cores/archive/refs/heads/main.zip" -OutFile "EnigMano.zip"
          Expand-Archive -Path "EnigMano.zip" -DestinationPath "./EnigMano"

      # Step 4: Start Chrome Remote Desktop host
      - name: Start Chrome Remote Desktop Host
        run: |
          cd ./EnigMano
          Write-Host "Starting CRD host with automated PIN..."
          # This line must point to your actual start_host script
          powershell -Command ".\start_host.ps1 --pin $env:CRD_PIN --headless"

      # Step 5: Confirm host is running
      - name: Verify CRD host
        run: |
          Write-Host "Listing running processes to confirm CRD started:"
          Get-Process | Where-Object {$_.ProcessName -like "*chrome*"} | Format-Table -AutoSize

      # Step 6: Output info
      - name: Connection Info
        run: |
          Write-Host "Your EnigMano Win11 instance should now be running."
          Write-Host "Use Google Chrome Remote Desktop to connect using PIN: $env:CRD_PIN"

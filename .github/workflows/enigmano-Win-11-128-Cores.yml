name: Jor3a-Ti9niya-RDP-NoVNC

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v2

    # --- Installer le serveur RDP si nécessaire ---
    - name: Enable RDP
      run: |
        # Autoriser les connexions RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        # Activer le firewall pour RDP
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # Créer un utilisateur pour se connecter
        $Password = ConvertTo-SecureString "admin@123" -AsPlainText -Force
        if (-Not (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "runneradmin" -Password $Password -FullName "RDP User" -Description "Utilisateur pour RDP"
            Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
        }

    # --- Installer noVNC & TigerVNC server ---
    - name: Download TigerVNC Server
      run: |
        Invoke-WebRequest -Uri "https://github.com/TigerVNC/tigervnc/releases/download/v1.13.0/tigervnc-1.13.0-vc14-x64.exe" -OutFile "$env:USERPROFILE\tigervnc.exe"
        Start-Process "$env:USERPROFILE\tigervnc.exe" -ArgumentList "/S" -Wait

    - name: Start VNC Server
      run: |
        # Démarrer VNC Server avec mot de passe simple
        & "C:\Program Files\TigerVNC\vncserver.exe" :1 -PasswordFile "$env:USERPROFILE\.vnc\passwd" -SecurityTypes None

    - name: Download cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start cloudflared tunnel
      run: |
        # Tunnel HTTP simple vers le port VNC (5901)
        Start-Process "$env:USERPROFILE\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:5901" -NoNewWindow

    # --- Installer noVNC web client ---
    - name: Download noVNC
      run: |
        Invoke-WebRequest -Uri "https://github.com/novnc/noVNC/archive/refs/heads/master.zip" -OutFile "$env:USERPROFILE\novnc.zip"
        Expand-Archive -Path "$env:USERPROFILE\novnc.zip" -DestinationPath "$env:USERPROFILE\novnc"

    - name: Start noVNC
      run: |
        Start-Process "python" -ArgumentList "-m http.server 6080 --directory $env:USERPROFILE\novnc\novnc-master" -NoNewWindow

    # --- Keep the workflow alive ---
    - name: Keep GitHub Runner Alive
      run: |
        Start-Sleep -Seconds 21600  # 6 heures

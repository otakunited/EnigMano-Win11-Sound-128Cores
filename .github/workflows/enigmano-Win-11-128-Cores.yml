name: "⚡ EnigMano Win11 + 128 Cores Deployment"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"

jobs:
  deploy-enigmano:
    name: "🚀 Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-Win-11-128-Cores.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}
      CRD_PIN: "123456" # <-- Définis ton PIN ici

    steps:
      - name: 📌 Deployment Parameters
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "==============================================="
          Write-Host "🔹 EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "🔢 Previous Instance     : $prevInstance"
          Write-Host "📦 GitHub Repository     : $env:REPO"
          Write-Host "🔁 Deployment Workflow   : $env:WORKFLOW_FILE"
          Write-Host "🆔 Deployment ID         : $env:DEPLOYMENT_ID"
          Write-Host "==============================================="

      - name: ⚡ Start Chrome Remote Desktop with PIN
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          function Timestamp { (Get-Date).ToString("yyyy-MM-dd HH:mm:ss") }
          function Log($msg) { Write-Host "[ENIGMANO $(Timestamp)] $msg" }
          function Fail($msg) { Write-Error "[ENIGMANO-ERROR $(Timestamp)] $msg"; Exit 1 }

          $now = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          Write-Host @"
----------------------------------------------------
         ENIGMANO INSTANCE $env:INSTANCE_ID BOOTING
----------------------------------------------------
  STATUS    : Initializing CRD host
  TIME      : $now
  ARCHITECT : SHAHZAIB-YT
----------------------------------------------------
"@

          # Vérifie que Chrome Remote Desktop est installé
          $CRDExe = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          if (!(Test-Path $CRDExe)) { Fail "❌ Chrome Remote Desktop not found at $CRDExe" }

          # Variables
          $HostName = $Env:COMPUTERNAME
          $CRDCode  = "4/0AVMBsJhftMkCYAJL_JDRkyfO7RODCsAIoltywFOEqBJJB38or1kETQN3XBFsEvGTG4KhqA"
          $PIN      = $Env:CRD_PIN

          # Active le Remote Desktop local si nécessaire
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Lancement du host Chrome Remote Desktop avec code et PIN
          Log "🚀 Starting Chrome Remote Desktop host..."
          Start-Process -FilePath $CRDExe -ArgumentList "--code=$CRDCode --redirect-url=https://remotedesktop.google.com/_/oauthredirect --name=$HostName --pin=$PIN" -NoNewWindow -Wait
          Log "✅ CRD host started with PIN $PIN. Remote access ready!"

      - name: 💠 Final Status
        if: always()
        shell: pwsh
        run: |
          Write-Host "✅ EnigMano Instance $env:INSTANCE_ID completed execution."
          Write-Host "🔋 Powered by: SHAHZAIB-YT"
          Write-Host "🏁 EnigMano deployment executed with tactical precision."

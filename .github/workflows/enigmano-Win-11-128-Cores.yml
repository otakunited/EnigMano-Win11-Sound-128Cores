name: Jor3a-Ti9niya-RDP-Cloudflared

on:
  workflow_dispatch:

jobs:
  setup-rdp-tunnel:
    runs-on: windows-latest

    steps:
    - name: Enable RDP
      run: |
        # Activer les connexions RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
        # Activer le firewall pour RDP
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        # Créer un utilisateur simple si pas déjà existant
        $Password = ConvertTo-SecureString "admin@123" -AsPlainText -Force
        if (-Not (Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "runneradmin" -Password $Password -FullName "RDP User" -Description "Utilisateur pour RDP"
            Add-LocalGroupMember -Group "Administrators" -Member "runneradmin"
        }

    - name: Download cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:USERPROFILE\cloudflared.exe"

    - name: Start cloudflared tunnel for RDP
      run: |
        # Tunnel TCP vers le port RDP (3389)
        Start-Process "$env:USERPROFILE\cloudflared.exe" -ArgumentList "tunnel --url tcp://localhost:3389" -NoNewWindow

    - name: Keep GitHub Runner Alive
      run: |
        Start-Sleep -Seconds 21600  # 6 heures
